import{a as Fi,b as Ni,d as k,t as Ei}from"./chunk-6E6TC7C7.js";import{a as Bi,b as ki,c as Ti}from"./chunk-JKFMD2YR.js";import{$c as X,Ac as ji,Ad as Y,Bc as V,Cc as W,D as zi,Dc as Mi,Ed as ni,Gc as _,Gd as Vi,Hd as Oi,I as $,Jc as I,K as vi,Kb as Ii,Kc as T,L as bi,O as D,Oc as si,Qc as F,Rc as H,S as w,Sc as wi,Wc as Ri,c as ei,d as ui,hc as yi,k as fi,l as K,m as mi,od as xi,pd as Ai,v as Si,vc as Q,wc as x,xa as ti,xc as R,yc as S,z as gi,zc as O}from"./chunk-7JDDZOZV.js";import{j as A}from"./chunk-TWZW5B45.js";var b=function(u){return u.Version0="0",u.Version1="1",u.Version2="2",u.Version3="3",u.Version4="4",u.Version5="5",u.Version6="6",u.Version7="7",u.Version8="8",u.Version9="9",u.Version10="10",u.Version11="11",u}(b||{});var L=(()=>{class u{constructor(){this.base64codes=new Uint8Array(256).fill(255),this.nToId=si(i=>i/W>=1?this.nToId(Math.floor(i/W))+this.nToId(i%W):V[i]),this.idToN=si(i=>{let e=Mi[i[0]];return i.length>1?(i=i.substring(1),e*Math.pow(W,i.length)+this.idToN(i)):e});for(let i=0;i<V.length;i++)this.base64codes[V.charCodeAt(i)]=i;this.base64codes[95]=0}deflate(i){return A(this,null,function*(){let e=yield this.compress(i,"deflate");return this.bytesToBase64(e)})}inflate(i){return A(this,null,function*(){try{return yield this.inflateStr(i)}catch{console.warn("Router failed to parse url, checking for missing trailing characters...")}try{return yield this.inflateMend(i,"-")}catch{}try{return yield this.inflateMend(i,".")}catch{}return yield this.inflateMend(i,"_")})}inflateMend(i,e){return A(this,null,function*(){let t=yield this.inflateStr(i+e);if(!t)throw new Error("Failed to parse, generated empty string");return console.warn(`Router mended url by appending '${e}'`),t})}inflateStr(i){return this.decompress(this.base64ToBytes(i))}bytesToBase64(i){let e="",t,n=i.length;for(t=2;t<n;t+=3)e+=V[i[t-2]>>2],e+=V[(i[t-2]&3)<<4|i[t-1]>>4],e+=V[(i[t-1]&15)<<2|i[t]>>6],e+=V[i[t]&63];return t===n+1&&(e+=V[i[t-2]>>2],e+=V[(i[t-2]&3)<<4],e+="__"),t===n&&(e+=V[i[t-2]>>2],e+=V[(i[t-2]&3)<<4|i[t-1]>>4],e+=V[(i[t-1]&15)<<2],e+="_"),e}getBase64Code(i){if(i>=this.base64codes.length)throw new Error("Unable to parse base64 string.");let e=this.base64codes[i];if(e===255)throw new Error("Unable to parse base64 string.");return e}base64ToBytes(i){if(i.length%4!==0)throw new Error("Unable to parse base64 string.");let e=i.indexOf("_");if(e!==-1&&e<i.length-2)throw new Error("Unable to parse base64 string.");let t=i.endsWith("__")?2:i.endsWith("_")?1:0,n=i.length,r=new Uint8Array(3*(n/4)),s;for(let o=0,c=0;o<n;o+=4,c+=3)s=this.getBase64Code(i.charCodeAt(o))<<18|this.getBase64Code(i.charCodeAt(o+1))<<12|this.getBase64Code(i.charCodeAt(o+2))<<6|this.getBase64Code(i.charCodeAt(o+3)),r[c]=s>>16,r[c+1]=s>>8&255,r[c+2]=s&255;return r.subarray(0,r.length-t)}compress(i,e="deflate"){return A(this,null,function*(){let t=new TextEncoder().encode(i),n=new CompressionStream(e),r=n.writable.getWriter();r.write(t),r.close();let s=new Response(n.readable).arrayBuffer();return new Uint8Array(yield s)})}decompress(i,e="deflate"){return A(this,null,function*(){let t=new DecompressionStream(e),n=t.writable.getWriter();n.write(i).catch(()=>{}),n.close().catch(()=>{});let r=new Response(t.readable).arrayBuffer();return new TextDecoder().decode(yield r)})}static{this.\u0275fac=function(e){return new(e||u)}}static{this.\u0275prov=D({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();var G=(()=>{class u{constructor(){this.compressionSvc=w(L)}zipFields(i){return i.join(S).replace(/\**$/,"")}zipString(i){return i??""}zipRational(i){return i==null?"":i.toString()}zipNumber(i){return i==null?"":i.toString()}zipArray(i){return i==null?"":i.length?i.join(R):x}zipNString(i,e){return i==null?"":this.compressionSvc.nToId(e.indexOf(i))}zipDiffSubset(i,e,t,n=t){if(i==null||e!=null&&Array.from(i).every(p=>e.has(p)))return"";if(i.size===0)return x;let r=new Set(t),s=[],o,c;return n.forEach((p,d)=>{if(r.has(p))if(i.has(p)){let h=this.compressionSvc.nToId(d);o==null?o=h:c=h}else o!=null&&(c==null?s.push(o):s.push(o+R+c),o=void 0,c=void 0)}),o!=null&&(c==null?s.push(o):s.push(o+R+c)),s.join(S)}zipDiffString(i,e,t){return i===e||i==null?"":[i,this.compressionSvc.nToId(t.indexOf(i))]}zipDiffNumber(i,e){return i===e||i==null?"":i.toString()}zipDiffRational(i,e){return i==null||e!=null&&i.eq(e)?"":i.toString()}zipDiffBool(i,e){return i===e?"":i?O:ji}zipDiffIndices(i,e){let t=i!=null?i.length>0?i.join(R):x:"",n=e!=null?e.length>0?e.join(R):x:"";return t===n?"":t}zipDiffArray(i,e,t){let n=i!=null?i.length>0?i.join(R):x:"",r=e!=null?e.length>0?e.join(R):x:"";return n===r?"":i==null||i.length===0?n:[n,i.map(s=>this.compressionSvc.nToId(t.indexOf(s))).join(R)]}parseString(i,e){if(e!=null)return this.parseNString(i,e);if(i?.length)return i}parseBool(i){if(i?.length)return i===O}parseNumber(i){if(i?.length)return Number(i)}parseRational(i){if(i?.length)return _(i)}parseArray(i,e){if(e)return this.parseNArray(i,e);if(i?.length)return i===x?[]:i.split(R)}parseIndices(i,e){if(i?.length)return i===x?[]:i.split(R).map(t=>Number(t)).map(t=>e[t]??{})}parseNString(i,e){let t=this.parseString(i);return t==null?t:e[this.compressionSvc.idToN(t)]}parseNArray(i,e){let t=this.parseArray(i);return t==null?t:t.map(n=>e[this.compressionSvc.idToN(n)])}parseSubset(i,e){if(!i?.length)return;if(i===x)return new Set;let t=i.split(S),n=new Set;for(let r of t){let[s,o]=r.split(R).map(d=>this.compressionSvc.idToN(d)),c=o!=null?o+1:s+1;e.slice(s,c).forEach(d=>n.add(d))}return n}set(i,e,t){return n=>(r,s,...o)=>{let c=s(e),p=s(t),d=n(c,p,...o),h,f;Array.isArray(d)?[h,f]=[...d]:h=f=d,h&&(i.bare[r]=h,i.hash[r]=f)}}get(i){return e=>(e=e.bind(this),(t,...n)=>e(i[t],...n))}static{this.\u0275fac=function(e){return new(e||u)}}static{this.\u0275prov=D({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();var g="_",J="?",a=function(u){return u.Version="v",u.Mod="b",u.Objectives="p",u.RecipeObjectives="q",u.Items="i",u.Recipes="r",u.Machines="f",u.Modules="m",u.Beacons="e",u.Settings="s",u.Zip="z",u}(a||{}),Z=function(u){return u.ExpensiveDeprecation="The expensive setting has been removed. Please use or request an expensive data set instead.",u.LimitStepDeprecation="Limit steps have been replaced by limit objectives. Results may differ if using multiple objectives as limits apply to all objectives.",u}(Z||{}),Di=(()=>{class u{constructor(){this.analyticsSvc=w(Ai),this.compressionSvc=w(L),this.contentSvc=w(Ni),this.translateSvc=w(Ri),this.zipSvc=w(G)}migrate(i,e){if(Object.keys(e).length===0)return{modId:i??Q,params:{},isBare:!0};e=H(e);let t=T(e.v,b.Version0);this.analyticsSvc.event("unzip_version",t);let n=e.z==null;(n||t===b.Version0)&&Object.keys(e).forEach(o=>{Array.isArray(e[o])?e[o]=e[o].map(c=>decodeURIComponent(c)):e[o]&&(e[o]=decodeURIComponent(e[o]))});let r=this.migrateAny(i,e,n,t);return this.displayWarnings(r.warnings),["o","i","r","m","e","b"].forEach(o=>{let c=r.params[o];typeof c=="string"&&(r.params[o]=[c])}),{modId:r.modId,params:r.params,isBare:r.isBare}}migrateAny(i,e,t,n){let s={modId:i,params:e,warnings:[],isBare:t};switch(n){case b.Version0:return this.migrateV0(s);case b.Version1:return this.migrateV1(s);case b.Version2:return this.migrateV2(s);case b.Version3:return this.migrateV3(s);case b.Version4:return this.migrateV4(s);case b.Version5:return this.migrateV5(s);case b.Version6:return this.migrateV6(s);case b.Version7:return this.migrateV7(s);case b.Version8:return this.migrateV8(s);case b.Version9:return this.migrateV9(s);case b.Version10:return this.migrateV10(s);default:return s}}migrateV0(i){let{params:e}=i;if(e[a.Settings]){let n=I(e[a.Settings]).split(S),r=this.zipSvc.parseString(n[0]);r=r&&X.modHash[X.modHashV0.indexOf(r)],r=r??"";let s=this.zipSvc.parseNumber(n[6])??60,o=s===1?"0":s===3600?"2":"1";e[a.Settings]=this.zipSvc.zipFields([r,o,I(e[a.Mod]),n[1],n[3],n[4],n[5],n[7],n[8],n[10],n[9],n[2],n[11],n[12]])}else e[a.Mod]&&(e[a.Settings]=this.zipSvc.zipFields([J,J,I(e[a.Mod])]));return delete e[a.Mod],e[a.Version]=b.Version1,this.migrateV1(i)}migrateV1(i){let{params:e,warnings:t}=i;if(e[a.Settings]){let r=I(e[a.Settings]).split(S),s=11;if(r.length>s){let o=r.splice(s,1);this.zipSvc.parseBool(o[0])&&t.push(Z.ExpensiveDeprecation)}e[a.Settings]=this.zipSvc.zipFields(r)}return e[a.Version]=b.Version4,this.migrateV4(i)}migrateV2(i){let{params:e}=i;if(e[a.Recipes]){let n=I(e[a.Recipes]).split(g),r=[],s=3;for(let o of n){let c=o.split(S);if(c.length>s){let p=this.parseNNumber(c[s])?.toString();c[s]=this.zipSvc.zipString(p)}r.push(this.zipSvc.zipFields(c))}e[a.Recipes]=r.join(g)}if(e[a.Machines]){let n=I(e[a.Machines]).split(g),r=[],s=2;for(let o of n){let c=o.split(S);if(c.length>s){let p=this.parseNNumber(c[s])?.toString();c[s]=this.zipSvc.zipString(p)}r.push(this.zipSvc.zipFields(c))}e[a.Machines]=r.join(g)}return e[a.Version]=b.Version3,this.migrateV3(i)}migrateV3(i){let{params:e,warnings:t}=i;if(e[a.Settings]){let r=I(e[a.Settings]).split(S),s=10;if(r.length>s){let o=r.splice(s,1);this.zipSvc.parseBool(o[0])&&t.push(Z.ExpensiveDeprecation)}e[a.Settings]=this.zipSvc.zipFields(r)}return e[a.Version]=b.Version5,this.migrateV5(i)}migrateInlineBeaconsSection(i,e,t,n){if(i[e]){let s=I(i[e]).split(g),o=[];for(let c of s.map(p=>p.split(S))){let p=t+1,d=p+1,h=d+3;if(c.length>t){let f,m,j;c.length>h&&(j=c.splice(h,1)[0]),c.length>d&&(f=c.splice(d,1)[0]),c.length>p&&(m=c.splice(p,1)[0]);let l=c[t];c[t]=this.zipSvc.zipArray([n.length]),n.push(this.zipSvc.zipFields([l,this.zipSvc.zipString(m),this.zipSvc.zipString(f),this.zipSvc.zipString(j)]))}o.push(this.zipSvc.zipFields(c))}i[e]=o.join(g)}}migrateInlineBeacons(i){let e=[];return this.migrateInlineBeaconsSection(i.params,a.RecipeObjectives,4,e),this.migrateInlineBeaconsSection(i.params,a.Recipes,3,e),e.length&&(i.params[a.Beacons]=e.join(g)),i}migrateV4(i){return i=this.migrateInlineBeacons(i),i.params[a.Version]=b.Version6,this.migrateV6(i)}migrateV5(i){return i=this.migrateInlineBeacons(i),i.params[a.Version]=b.Version7,this.migrateV7(i)}migrateInsertField(i,e,t){if(i[e]){let n=I(i[e]).split(g);for(let r=0;r<n.length;r++){let s=n[r].split(S);s.length>t&&(s.splice(t,0,""),n[r]=this.zipSvc.zipFields(s))}i[e]=n.join(g)}}migrateDeleteField(i,e,t){if(i[e]){let n=I(i[e]).split(g);for(let r=0;r<n.length;r++){let s=n[r].split(S);s.length>t&&(s.splice(t,1),n[r]=this.zipSvc.zipFields(s))}i[e]=n.join(g)}}migrateMoveUpField(i,e,t){if(i[e]!=null){let n=i[e];for(i.splice(e,1),i.length>t&&i.splice(t,0,"");i.length<=t;)i.push("");i[t]=n}}migrateToV8(i){let{params:e,isBare:t}=i,n=!1;if(this.migrateInsertField(e,a.RecipeObjectives,2),e[a.Objectives]){let r=I(e[a.Objectives]).split(g),s=[...r];for(let o=0;o<r.length;o++){let p=r[o].split(S);if(p[2]==="3")if(t){let d=e[a.RecipeObjectives]?I(e[a.RecipeObjectives]).split(g):[];if(p.length>3){let h=[p[3],p[1],k.Limit.toString()],f=[p[0],"1",k.Maximize.toString()];d.push(this.zipSvc.zipFields(f)),d.push(this.zipSvc.zipFields(h)),n=!0}else d.push(this.zipSvc.zipFields([p[0],p[1]]));s.splice(o,1),e[a.RecipeObjectives]=d.join(g)}else p[2]="0",s[o]=this.zipSvc.zipFields(p);else if(p.length>3){let d=[p[3],p[1],p[2],k.Limit.toString()],h=[p[0],"1","",k.Maximize.toString()];s[o]=this.zipSvc.zipFields(h),s.push(this.zipSvc.zipFields(d)),n=!0}}n&&i.warnings.push(Z.LimitStepDeprecation),e[a.Objectives]=s.join(g)}if(this.migrateDeleteField(e,a.Items,4),this.migrateInsertField(e,a.Recipes,1),e[a.Settings]){let r=I(e[a.Settings]).split(S),s=t?1:0;if(r.length>2+s){let o=this.zipSvc.parseArray(r[2+s]);if(o){let c=I(e[a.Recipes]),p=c?c.split(g):[];for(let d of o){let h=!1;for(let f=0;f<p.length;f++){let m=p[f].split(S);m[0]===d&&(h=!0,m[1]=O,p[f]=this.zipSvc.zipFields(m))}h||p.push(this.zipSvc.zipFields([d,O]))}e[a.Recipes]=p.join(g)}r.splice(2+s,1)}r.splice(s,0,""),this.migrateMoveUpField(r,16+s,20+s),this.migrateMoveUpField(r,15+s,19+s),this.migrateMoveUpField(r,14+s,18+s),this.migrateMoveUpField(r,13+s,17+s),e[a.Settings]=this.zipSvc.zipFields(r)}return e[a.Version]=b.Version8,i}migrateV6(i){return i.isBare=!0,this.migrateV8(this.migrateToV8(i))}migrateV7(i){return i.isBare=!1,this.migrateV8(this.migrateToV8(i))}migrateV8(i){let{params:e}=i;if(e[a.RecipeObjectives]){let t=[];e[a.Objectives]&&(t=I(e[a.Objectives]).split(g));let n=I(e[a.RecipeObjectives]).split(g);for(let r of n){let s=r.split(S),o=this.zipSvc.zipFields([s[0],s[1],"3",s[2],s[3],s[4],s[5],s[6],s[7]]);t.push(o)}e[a.RecipeObjectives]="",e[a.Objectives]=t.join(g)}return this.migrateV9(i)}migrateInlineModulesSection(i,e,t,n){if(i[e]){let s=I(i[e]).split(g),o=[];for(let c of s.map(p=>p.split(S))){if(c.length>t){let p=c[t],d=this.zipSvc.parseArray(p);if(d==null)continue;let h=new Map;for(let m of d){let j=h.get(m)??0;h.set(m,j+1)}let f=Array.from(h.keys()).map((m,j)=>n.length+j);c[t]=this.zipSvc.zipArray(f);for(let m of h.keys())n.push(this.zipSvc.zipFields([T(h.get(m)?.toString(),""),m]))}o.push(this.zipSvc.zipFields(c))}i[e]=o.join(g)}}migrateV9(i){let{params:e}=i,t=[];if(this.migrateInlineModulesSection(i.params,a.Beacons,1,t),this.migrateInlineModulesSection(i.params,a.Recipes,3,t),this.migrateInlineModulesSection(i.params,a.Objectives,5,t),i.params[a.Machines]){let r=I(e[a.Machines]).split(g),s=[],o=i.params[a.Beacons]?I(i.params[a.Beacons]).split(g):[],c=2,p=c+1,d=p+1;r.map(h=>h.split(S)).forEach((h,f)=>{if(f===0&&h[0]===O&&(h[0]=x),this.migrateMoveUpField(h,5,6),h[0]!==x&&h[0]!==""&&h.length>1){let m=h[1];if(m){let j=m.split(R)[0];h[1]=this.zipSvc.zipArray([t.length]),t.push(this.zipSvc.zipFields(["",j]))}}if(h.length>2){let m,j;if(h.length>d&&(m=h.splice(d,1)[0]),h.length>p){let y=h.splice(p,1)[0];if(y){let N=y.split(R)[0];j=[t.length],t.push(this.zipSvc.zipFields(["",N]))}}let l=h[c];h[c]=this.zipSvc.zipArray([o.length]),o.push(this.zipSvc.zipFields([l,this.zipSvc.zipArray(j),this.zipSvc.zipString(m)]))}s.push(this.zipSvc.zipFields(h))}),o.length&&(i.params[a.Beacons]=o.join(g)),i.params[a.Machines]=s.join(g)}if(t.length&&(i.params[a.Modules]=t.join(g)),e[a.Settings]){let n=I(e[a.Settings]).split(S),r=i.isBare?5:4;if(n.length>r){let s=n.splice(r,1)[0];if(e[a.Machines]){let o=I(e[a.Machines]).split(g).map(p=>p.split(S)),c=o.find(p=>p[0]===x||p[0]==="");if(c){for(;c.length<4;)c.push("");c[3]=s}else o.unshift(["","","",s]);e[a.Machines]=o.map(p=>this.zipSvc.zipFields(p)).join(g)}else e[a.Machines]=["","","",s].join(S);e[a.Settings]=n.join(S)}}return e[a.Version]=b.Version10,this.migrateV10(i)}migrateV10(i){let{params:e}=i;delete e[a.RecipeObjectives];let t=new Set,n=new Set,r=new Set,s=new Set,o=new Set;function c(v,z){z.size!==0&&(e[v]=Array.from(z).join(R))}let p=e[a.Modules];delete e[a.Modules];let d=p?.split(g),h=e[a.Beacons];delete e[a.Beacons];let f=h?.split(g),m=e[a.Objectives];delete e[a.Objectives];let j=[],l=m?.split(g).map((v,z)=>{let M=v.split(S),U=z.toString();return j.push(U),M[8]===O&&t.add(U),M.splice(8,1),M.join(S)}).filter(v=>v);l?.length&&(e.o=l),t.size&&(e.och=this.zipSvc.zipDiffSubset(t,void 0,j));let y=e[a.Items];delete e[a.Items];let N=y?.split(g).map(v=>{let z=v.split(S),M=z[0];return z[1]===O&&n.add(M),z[4]===O&&r.add(M),z.splice(4,1),z.splice(1,1),z.join(S)}).filter(v=>v);N?.length&&(e.i=N),c("v10iex",n),c("v10ich",r);let B=e[a.Recipes];delete e[a.Recipes];let E=B?.split(g).map(v=>{let z=v.split(S),M=z[0];return z[1]===O&&s.add(M),z[7]===O&&o.add(M),z.splice(7,1),z.splice(1,1),z.join(S)}).filter(v=>v);E?.length&&(e.r=E),c("v10rex",s),c("v10rch",o);let Ui=e[a.Machines];delete e[a.Machines];let q,ci,oi,pi,ai,ii=[];Ui?.split(g).forEach((v,z)=>{let M=v.split(S),U=M[0];z===0?(U===x&&(q=[]),oi=M[1],pi=M[2],ci=M[3],ai=M[4]):(q?.push(U),M.length>1&&ii.push(v))}),ii.length&&(e.m=ii),e.mmr=q?.join(R),e.mfr=ci,e.mer=oi,e.mbe=pi,e.moc=ai;let li=e[a.Settings];if(delete e[a.Settings],li){let v=li.split(S),z=i.isBare?v.splice(0,1)[0]:void 0;z&&(i.modId=z);let M=v[0];M&&M!==J&&c("v10tre",new Set(M.split(R))),["odr","mpr","ibe","ifr","bmi","bre","bic","mit","icw","ifw","ipi","mbr","mps","rnp","omt","cfa","cma","cun","cex","csu","cmx","osm","cfp"].forEach((di,C)=>{e[di]=v[C+1]||void 0}),i.isBare||["ifr","bmi","bre","omt"].filter(C=>e[C]!=null).forEach(C=>{e[C]=this.parseNNumber(I(e[C]))?.toString()})}let Ci=e[a.Mod];delete e[a.Mod];let P=Ci;P&&!i.isBare&&(P=X.modHash[this.compressionSvc.idToN(P)]),P&&(i.modId=P),e.e=d,e.b=f,e.v=b.Version11,F(e);function hi(v){return v.replaceAll(J,"").replaceAll(x,x)}return Object.keys(e).forEach(v=>{let z=e[v];Array.isArray(z)?e[v]=z.map(M=>hi(M)):z&&(e[v]=hi(z))}),i}restoreV10ResearchedTechnologies(i,e){let t=e.items.filter(c=>c.technology),n=t.map(c=>c.id);if(i==null||!n.length)return;let r=new Set(i),s=wi(t),o;do{o=new Set;for(let c of r)s[c].technology?.prerequisites?.filter(d=>!r.has(d)).forEach(d=>o.add(d));o.forEach(c=>r.add(c))}while(o.size);if(r.size!==n.length)return r}parseNNumber(i){if(i?.length)return this.compressionSvc.idToN(i)}parseSet(i,e){if(i==null)return;let t=i.split(R);return e==null?new Set(t):new Set(t.map(n=>e[this.compressionSvc.idToN(n)]))}displayWarnings(i){this.translateSvc.multi(["app.migrationWarning","OK"]).pipe(zi()).subscribe(([e,t])=>{for(let n of i)this.contentSvc.confirm({message:n,header:e,acceptLabel:t,rejectVisible:!1})})}static{this.\u0275fac=function(e){return new(e||u)}}static{this.\u0275prov=D({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();var Be=(()=>{class u{get empty(){return{bare:{},hash:{}}}get emptyRecipeSettingsInfo(){return{idMap:{},list:[]}}get emptyMachineSettings(){return{moduleMap:{},beaconMap:{}}}constructor(){this.router=w(yi),this.compressionSvc=w(L),this.dataSvc=w(Fi),this.itemsSvc=w(Bi),this.machinesSvc=w(ki),this.migrationSvc=w(Di),this.objectivesSvc=w(Ei),this.recipesSvc=w(Ti),this.settingsSvc=w(Oi),this.zipSvc=w(G),this.zipState$=new ei,this.zipConfig=ti(this.empty),this.version=b.Version11,this.zipTail={v:this.version},this.route$=new ei,this.ready=ti(!1),this.navigating$=new ui(!1),this.stored=xi("router"),this.route$.pipe($(i=>mi({params:i.params,queryParams:i.queryParams})),bi(this.navigating$),Si(([i,e])=>!e),K(([i])=>i),$(t=>A(this,[t],function*({params:i,queryParams:e}){return e=yield this.unzipQueryParams(e),{params:i,queryParams:e}})),K(({params:i,queryParams:e})=>this.migrationSvc.migrate(i.id,e)),$(({modId:i,params:e,isBare:t})=>this.updateState(i,e,t))).subscribe(),Ii(()=>{let i=this.ready(),e=this.settingsSvc.hash();if(!i||!e)return;let t=this.objectivesSvc.state(),n=this.itemsSvc.state(),r=this.recipesSvc.state(),s=this.machinesSvc.state(),o=this.settingsSvc.state(),c=this.settingsSvc.dataset();this.zipState$.next({objectives:t,items:n,recipes:r,machines:s,settings:o,data:c,hash:e})}),this.zipState$.pipe(gi(0),K(i=>this.zipState(i)),vi(i=>{this.zipConfig.set(i.config)}),$(i=>this.updateUrl(i))).subscribe()}updateUrl(i){return A(this,null,function*(){let e=yield this.getHash(i);this.navigating$.next(!0),yield this.router.navigate([],{queryParams:e}),this.navigating$.next(!1);let t=this.router.url,n=t.split("?")[0];(n.endsWith("list")||n.endsWith("flow"))&&this.stored.set(t)})}zipState(i){let{objectives:e,items:t,recipes:n,machines:r,settings:s,data:o,hash:c}=i,p=this.zipModulesBeacons(e,n,r,s,c);return this.zipObjectives(p,e,c),this.zipItems(p,t,c),this.zipRecipes(p,n,c),this.zipMachines(p,r,c),this.zipSettings(p,s,Object.keys(e),o,c),p}stepHref(i,e,t){return A(this,null,function*(){if(t==null)return null;let n;if(i.itemId!=null&&i.items!=null?n={1:{id:"1",targetId:i.itemId,value:i.items,unit:Y.Items,type:k.Output}}:i.recipeId!=null&&i.machines!=null&&(n={1:{id:"1",targetId:i.recipeId,value:i.machines,unit:Y.Machines,type:k.Output}}),n==null)return null;let r={objectives:this.empty,config:e,objectiveSettings:this.emptyMachineSettings,recipeSettings:this.emptyMachineSettings,machineSettings:this.emptyMachineSettings};return this.zipObjectives(r,n,t),yield this.getHash(r)})}getHash(i){return A(this,null,function*(){let e=H(i.objectives.bare,i.config.bare,this.zipTail),t=H(i.objectives.hash,i.config.hash,this.zipTail),n=this.toString(t),s={z:yield this.compressionSvc.deflate(n),v:this.version},c=this.toString(e).length,d=this.toString(s).length;return c<Math.max(d,200)?e:s})}toParams(i){let e=i.split("&");return e.some(t=>!t.includes("="))?e.reduce((t,n)=>(t[n[0]]=n.substring(1),t),{}):e.reduce((t,n)=>{let[r,s]=n.split("=");return t[r]=s,t},{})}toString(i){return Object.keys(i).flatMap(e=>{let t=i[e];return Array.isArray(t)?t.map(n=>`${e}=${n}`):t?`${e}=${t}`:[]},"").join("&")}unzipQueryParams(i){return A(this,null,function*(){let e=i.z;if(e!=null)try{let t=I(e).replace(/\+/g,"-").replace(/\//g,".").replace(/=/g,"_"),n=yield this.compressionSvc.inflate(t);i=this.toParams(n),i.z=e}catch(t){throw console.error(t),new Error("RouterService failed to parse url")}return i})}updateState(i,e,t){return A(this,null,function*(){if(i==null&&Object.keys(e).length===0){this.ready.set(!0);return}let[n,r]=yield fi(this.dataSvc.requestData(i??Q)),s=t?void 0:r,o=this.unzipModules(e,s),c=this.unzipBeacons(e,o,s),p={};p.objectivesState=this.unzipObjectives(e,o,c,s),p.itemsState=this.unzipItems(e,s),p.recipesState=this.unzipRecipes(e,o,c,s),p.machinesState=this.unzipMachines(e,o,c,s);let d=p.objectivesState?Object.keys(p.objectivesState):[];p.settingsState=this.unzipSettings(i,e,c,d,n,r,s),this.dispatch(p)})}dispatch(i){this.objectivesSvc.load(i.objectivesState),this.itemsSvc.load(i.itemsState),this.recipesSvc.load(i.recipesState),this.machinesSvc.load(i.machinesState),this.settingsSvc.load(i.settingsState),this.ready.set(!0)}zipModulesBeacons(i,e,t,n,r){let s=this.emptyRecipeSettingsInfo,o=this.emptyRecipeSettingsInfo,c=y=>this.zipMachineSettings(y,s,o,r),p=c(i),d=c(e),h=c(t),f;if(n.beacons){let y=this.beaconModuleMap(n.beacons,s,r);f=this.zipBeaconArray(n.beacons,y,o,r)}let m=this.empty,j=["bare","hash"];return[["e",s.list],["b",o.list]].forEach(([y,N])=>{N.forEach(B=>{j.forEach(E=>{m[E][y]==null?m[E][y]=[B[E]]:m[E][y].push(B[E])})})}),{objectives:this.empty,config:m,objectiveSettings:p,recipeSettings:d,machineSettings:h,beacons:f}}zipMachineSettings(i,e,t,n){let r=this.emptyMachineSettings;for(let s of Object.keys(i)){let o=i[s];if(o.modules!=null&&(r.moduleMap[s]=this.zipModuleArray(o.modules,e,n)),o.beacons!=null){let c=this.beaconModuleMap(o.beacons,e,n);r.beaconMap[s]=this.zipBeaconArray(o.beacons,c,t,n)}}return r}beaconModuleMap(i,e,t){return i.map(n=>{if(n.modules!=null)return this.zipModuleArray(n.modules,e,t)})}zipModuleArray(i,e,t){return i.map(n=>{let r=this.zipSvc.zipRational(n.count),s={bare:this.zipSvc.zipFields([r,this.zipSvc.zipString(n.id)]),hash:this.zipSvc.zipFields([r,this.zipSvc.zipNString(n.id,t.modules)])};return e.idMap[s.bare]==null&&(e.idMap[s.bare]=e.list.length,e.list.push(s)),e.idMap[s.bare]})}unzipModules(i,e){return i.e==null?[]:i.e.map(t=>{let n=t.split(S),r=0,s={count:this.zipSvc.parseRational(n[r++]),id:this.zipSvc.parseString(n[r++],e?.modules)};return F(s),s})}zipBeaconArray(i,e,t,n){return i.map((r,s)=>{let o=this.zipSvc.zipRational(r.count),c=this.zipSvc.zipArray(e[s]),p=this.zipSvc.zipRational(r.total),d={bare:this.zipSvc.zipFields([o,c,this.zipSvc.zipString(r.id),p]),hash:this.zipSvc.zipFields([o,c,this.zipSvc.zipNString(r.id,n.beacons),p])};return t.idMap[d.bare]==null&&(t.idMap[d.bare]=t.list.length,t.list.push(d)),t.idMap[d.bare]})}unzipBeacons(i,e,t){return i.b==null?[]:i.b.map(n=>{let r=n.split(S),s=0,o={count:this.zipSvc.parseRational(r[s++]),modules:this.zipSvc.parseIndices(r[s++],e),id:this.zipSvc.parseString(r[s++],t?.beacons),total:this.zipSvc.parseRational(r[s++])};return F(o),o})}zipObjectives(i,e,t){let n=Object.keys(e);if(!n.length)return;let r=n.map(s=>e[s]);i.objectives.bare.o=[],i.objectives.hash.o=[];for(let s of r){let o=this.zipSvc.zipDiffRational(s.value,_.one),c=this.zipSvc.zipDiffNumber(s.unit,Y.Items),p=this.zipSvc.zipDiffNumber(s.type,k.Output),d=this.zipSvc.zipArray(i.objectiveSettings.moduleMap[s.id]),h=this.zipSvc.zipArray(i.objectiveSettings.beaconMap[s.id]),f=this.zipSvc.zipNumber(s.overclock);i.objectives.bare.o.push(this.zipSvc.zipFields([s.targetId,o,c,p,this.zipSvc.zipString(s.machineId),d,h,f,this.zipSvc.zipString(s.fuelId)])),i.objectives.hash.o.push(this.zipSvc.zipFields([this.zipSvc.zipNString(s.targetId,ni(s)?t.recipes:t.items),o,c,p,this.zipSvc.zipNString(s.machineId,t.machines),d,h,f,this.zipSvc.zipNString(s.fuelId,t.fuels)]))}}unzipObjectives(i,e,t,n){if(i.o==null)return;let r={},s=1;for(let o of i.o){let c=o.split(S),p=0,d=s.toString(),h={id:s.toString(),targetId:c[p++],value:T(this.zipSvc.parseRational(c[p++]),_.one),unit:this.zipSvc.parseNumber(c[p++])??Y.Items,type:this.zipSvc.parseNumber(c[p++])??k.Output,machineId:this.zipSvc.parseString(c[p++],n?.machines),modules:this.zipSvc.parseIndices(c[p++],e),beacons:this.zipSvc.parseIndices(c[p++],t),overclock:this.zipSvc.parseRational(c[p++]),fuelId:this.zipSvc.parseString(c[p++],n?.fuels)};n&&(h.targetId=T(this.zipSvc.parseNString(h.targetId,ni(h)?n.recipes:n.items),"")),F(h),r[d]=h,s++}return r}zipItems(i,e,t){let n=Object.keys(e);if(n.length){i.config.bare.i=[],i.config.hash.i=[];for(let r of n){let s=e[r];i.config.bare.i.push(this.zipSvc.zipFields([r,this.zipSvc.zipString(s.beltId),this.zipSvc.zipString(s.wagonId)])),i.config.hash.i.push(this.zipSvc.zipFields([this.zipSvc.zipNString(r,t.items),this.zipSvc.zipNString(s.beltId,t.belts),this.zipSvc.zipNString(s.wagonId,t.wagons)]))}}}unzipItems(i,e){if(i.i==null)return;let t={};for(let n of i.i){let r=n.split(S),s=0,o=T(this.zipSvc.parseString(r[s++],e?.items),""),c={beltId:this.zipSvc.parseString(r[s++],e?.belts),wagonId:this.zipSvc.parseString(r[s++],e?.wagons)};F(c),Object.keys(c).length&&(t[o]=c)}return t}zipRecipes(i,e,t){let n=Object.keys(e);if(n.length){i.config.bare.r=[],i.config.hash.r=[];for(let r of n){let s=e[r],o=this.zipSvc.zipArray(i.recipeSettings.moduleMap[r]),c=this.zipSvc.zipArray(i.recipeSettings.beaconMap[r]),p=this.zipSvc.zipNumber(s.overclock),d=this.zipSvc.zipNumber(s.cost);i.config.bare.r.push(this.zipSvc.zipFields([r,this.zipSvc.zipString(s.machineId),o,c,p,d,this.zipSvc.zipString(s.fuelId)])),i.config.hash.r.push(this.zipSvc.zipFields([this.zipSvc.zipNString(r,t.recipes),this.zipSvc.zipNString(s.machineId,t.machines),o,c,p,d,this.zipSvc.zipNString(s.fuelId,t.fuels)]))}}}unzipRecipes(i,e,t,n){if(i.r==null)return;let r={};for(let s of i.r){let o=s.split(S),c=0,p=T(this.zipSvc.parseString(o[c++],n?.recipes),""),d={machineId:this.zipSvc.parseString(o[c++],n?.machines),modules:this.zipSvc.parseArray(o[c++])?.map(h=>e[Number(h)]??{}),beacons:this.zipSvc.parseArray(o[c++])?.map(h=>t[Number(h)]??{}),overclock:this.zipSvc.parseRational(o[c++]),cost:this.zipSvc.parseRational(o[c++]),fuelId:this.zipSvc.parseString(o[c++],n?.fuels)};F(d),Object.keys(d).length&&(r[p]=d)}return r}zipMachines(i,e,t){let n=Object.keys(e);if(n.length){i.config.bare.m=[],i.config.hash.m=[];for(let r of n){let s=e[r],o=this.zipSvc.zipArray(i.machineSettings.moduleMap[r]),c=this.zipSvc.zipArray(i.machineSettings.beaconMap[r]),p=this.zipSvc.zipNumber(s.overclock);i.config.bare.m.push(this.zipSvc.zipFields([r,o,c,this.zipSvc.zipString(s.fuelId),p])),i.config.hash.m.push(this.zipSvc.zipFields([this.zipSvc.zipNString(r,t.machines),o,c,this.zipSvc.zipNString(s.fuelId,t.fuels),p]))}}}unzipMachines(i,e,t,n){if(i.m==null)return;let r={};for(let s of i.m){let o=s.split(S),c=0,p=T(this.zipSvc.parseString(o[c++],n?.machines),""),d={modules:this.zipSvc.parseArray(o[c++])?.map(h=>e[Number(h)]??{}),beacons:this.zipSvc.parseArray(o[c++])?.map(h=>t[Number(h)]??{}),fuelId:this.zipSvc.parseString(o[c++],n?.fuels),overclock:this.zipSvc.parseRational(o[c++])};F(d),Object.keys(d).length&&(r[p]=d)}return r}zipSettings(i,e,t,n,r){let s=Vi,o=this.zipSvc.set(i.config,e,s),c=o(this.zipSvc.zipDiffSubset.bind(this.zipSvc)),p=o(this.zipSvc.zipDiffNumber.bind(this.zipSvc)),d=o(this.zipSvc.zipDiffBool.bind(this.zipSvc)),h=o(this.zipSvc.zipDiffString.bind(this.zipSvc)),f=o(this.zipSvc.zipDiffRational.bind(this.zipSvc)),m=o(this.zipSvc.zipDiffArray.bind(this.zipSvc)),j=o(this.zipSvc.zipDiffIndices.bind(this.zipSvc));c("och",l=>l.checkedObjectiveIds,t),p("omt",l=>l.maximizeType),d("osm",l=>l.surplusMachinesOutput),p("odr",l=>l.displayRate),c("iex",l=>l.excludedItemIds,n.itemIds,r.items),c("ich",l=>l.checkedItemIds,n.itemIds,r.items),h("ibe",l=>l.beltId,r.belts),h("ipi",l=>l.pipeId,r.belts),h("icw",l=>l.cargoWagonId,r.wagons),h("ifw",l=>l.fluidWagonId,r.wagons),f("ifr",l=>l.flowRate),c("rex",l=>l.excludedRecipeIds,n.recipeIds,r.recipes),c("rch",l=>l.checkedRecipeIds,n.recipeIds,r.recipes),d("rnp",l=>l.netProductionOnly),p("mpr",l=>l.preset),m("mmr",l=>l.machineRankIds,r.machines),m("mfr",l=>l.fuelRankIds,r.fuels),m("mer",l=>l.moduleRankIds,r.modules),j("mbe",l=>l===s?void 0:i.beacons),f("moc",l=>l.overclock),f("mbr",l=>l.beaconReceivers),h("mps",l=>l.proliferatorSprayId,r.modules),p("mit",l=>l.inserterTarget),f("bmi",l=>l.miningBonus),f("bre",l=>l.researchBonus),p("bic",l=>l.inserterCapacity),c("tre",l=>l.researchedTechnologyIds,n.technologyIds,r.technologies),f("cfa",l=>l.costs.factor),f("cma",l=>l.costs.machine),f("cfp",l=>l.costs.footprint),f("cun",l=>l.costs.unproduceable),f("cex",l=>l.costs.excluded),f("csu",l=>l.costs.surplus),f("cmx",l=>l.costs.maximize)}unzipSettings(i,e,t,n,r,s,o){let c=this.zipSvc.get(e),p=c(this.zipSvc.parseSubset.bind(this.zipSvc)),d=c(this.zipSvc.parseNumber.bind(this.zipSvc)),h=c(this.zipSvc.parseBool.bind(this.zipSvc)),f=c(this.zipSvc.parseString.bind(this.zipSvc)),m=c(this.zipSvc.parseRational.bind(this.zipSvc)),j=c(this.zipSvc.parseArray.bind(this.zipSvc)),l=c(this.zipSvc.parseIndices.bind(this.zipSvc)),y={modId:i,checkedObjectiveIds:p("och",n),maximizeType:d("omt"),surplusMachinesOutput:h("osm"),displayRate:d("odr"),excludedItemIds:p("iex",s.items),checkedItemIds:p("ich",s.items),beltId:f("ibe",o?.belts),pipeId:f("ipi",o?.belts),cargoWagonId:f("icw",o?.wagons),fluidWagonId:f("ifw",o?.wagons),flowRate:m("ifr"),excludedRecipeIds:p("rex",s.recipes),checkedRecipeIds:p("rch",s.recipes),netProductionOnly:h("rnp"),preset:d("mpr"),machineRankIds:j("mmr",o?.machines),fuelRankIds:j("mfr",o?.fuels),moduleRankIds:j("mer",o?.modules),beacons:l("mbe",t),overclock:m("moc"),beaconReceivers:m("mbr"),proliferatorSprayId:f("mps",o?.modules),inserterTarget:d("mit"),miningBonus:m("bmi"),researchBonus:m("bre"),inserterCapacity:d("bic"),researchedTechnologyIds:p("tre",s.technologies)},N={factor:m("cfa"),machine:m("cma"),footprint:m("cfp"),unproduceable:m("cun"),excluded:m("cex"),surplus:m("csu"),maximize:m("cmx")},B=this.migrationSvc.parseSet.bind(this.migrationSvc);if(e.v10iex&&(y.excludedItemIds=B(e.v10iex,o?.items)),e.v10ich&&(y.checkedItemIds=B(e.v10ich,o?.items)),e.v10rex&&(y.excludedRecipeIds=B(e.v10rex,o?.recipes)),e.v10rch&&(y.checkedRecipeIds=B(e.v10rch,o?.recipes)),e.v10tre&&(y.researchedTechnologyIds=B(e.v10tre,o?.technologies),y.researchedTechnologyIds=this.migrationSvc.restoreV10ResearchedTechnologies(y.researchedTechnologyIds,r)),F(N),Object.keys(N).length&&(y.costs=N),F(y),!!Object.keys(y).length)return y}static{this.\u0275fac=function(e){return new(e||u)}}static{this.\u0275prov=D({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();export{Di as a,Be as b};
